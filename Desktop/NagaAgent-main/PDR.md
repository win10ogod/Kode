# NagaAgent 3.0 项目需求分析文档 (PDR)

## 项目概述

### 项目名称
NagaAgent 3.0 - 智能对话助手系统

### 项目定位
一个功能完整的智能对话助手平台，集成了多MCP服务、流式语音交互、GRAG知识图谱记忆系统、RESTful API接口等核心功能，采用极致精简的代码风格和模块化架构设计。

### 技术栈
- **核心语言**: Python 3.8+
- **AI模型**: 支持OpenAI兼容API（推荐DeepSeek V3）
- **GUI框架**: PyQt5
- **Web框架**: FastAPI + Uvicorn
- **数据库**: Neo4j（知识图谱）
- **语音服务**: Edge-TTS
- **浏览器自动化**: Playwright
- **消息协议**: MCP (Model Context Protocol)

---

## 系统架构

### 1. 核心架构模式
```
┌─────────────────────────────────────────────────────────────┐
│                    NagaAgent 3.0 系统架构                    │
├─────────────────────────────────────────────────────────────┤
│  用户界面层                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  PyQt5 GUI  │  │ RESTful API │  │ WebSocket   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│  核心对话引擎                                                │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │           NagaConversation 核心对话处理器                │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  功能扩展层                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ MCP服务管理  │  │ Agent管理器  │  │ 树状思考引擎 │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 语音处理系统 │  │ GRAG记忆系统 │  │ 预处理系统   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│  服务集成层                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 天气时间服务 │  │ 设备控制服务 │  │ 文档处理服务 │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 浏览器控制   │  │ 应用启动器   │  │ 系统控制     │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

### 2. 数据流架构
```
用户输入 → 预处理 → 对话引擎 → 工具调用循环 → 响应生成 → 后处理 → 用户输出
    ↓         ↓         ↓           ↓           ↓         ↓         ↓
  语音识别   消息过滤   LLM推理    MCP服务     流式输出   记忆存储   语音合成
```

---

## 功能需求分析

### 1. 核心对话功能

#### 1.1 基础对话能力
- **需求描述**: 支持与用户进行自然语言对话
- **技术实现**: 基于OpenAI兼容API的LLM调用
- **关键特性**:
  - 支持流式和非流式响应
  - 多轮对话上下文管理
  - 温度、最大token等参数可配置
  - 支持系统提示词定制

#### 1.2 工具调用循环系统
- **需求描述**: 支持LLM主动调用外部工具完成复杂任务
- **技术实现**: 基于TOOL_REQUEST格式的工具调用解析
- **关键特性**:
  - 支持MCP和Agent两种调用类型
  - 递归调用深度控制（流式/非流式模式）
  - 工具调用结果自动反馈给LLM
  - 异常处理和错误恢复

#### 1.3 消息预处理系统
- **需求描述**: 对用户输入进行预处理和增强
- **技术实现**: 基于插件化的预处理器架构
- **关键特性**:
  - 占位符替换（时间、环境变量、Agent信息）
  - 图片处理（下载、格式转换、压缩）
  - 静态插件支持
  - 异步结果处理

### 2. MCP服务集成

#### 2.1 MCP服务管理
- **需求描述**: 统一管理和调用各种MCP服务
- **技术实现**: MCPManager + MCP Registry架构
- **关键特性**:
  - 自动服务发现和注册
  - 服务连接池管理
  - 工具缓存和性能优化
  - 服务状态监控

#### 2.2 内置MCP服务
- **天气时间服务**: 天气查询、时间获取、城市信息
- **设备控制服务**: MQTT设备开关控制
- **文档处理服务**: Word文档创建、编辑、格式化
- **浏览器控制**: 网页自动化操作
- **应用启动器**: 系统应用启动和管理
- **系统控制**: 系统设置调节（音量、亮度等）
- **记忆管理**: GRAG知识图谱记忆存储和检索

### 3. Agent管理系统

#### 3.1 多Agent架构
- **需求描述**: 支持多个专门化Agent协同工作
- **技术实现**: AgentManager + AgentRegistry架构
- **关键特性**:
  - Agent自动发现和注册
  - 会话管理和上下文隔离
  - 任务分发和结果聚合
  - Agent间通信协议

#### 3.2 专门化Agent
- **Word Agent**: 专门处理Word文档相关任务
- **Weather Agent**: 天气和时间查询专家
- **Device Agent**: 设备控制专家
- **Memory Agent**: 记忆管理专家
- **Browser Agent**: 浏览器自动化专家

### 4. 语音交互系统

#### 4.1 语音识别 (STT)
- **需求描述**: 将用户语音转换为文本
- **技术实现**: 基于语音识别API
- **关键特性**:
  - 实时语音流处理
  - 多语言支持
  - 噪音过滤和优化

#### 4.2 语音合成 (TTS)
- **需求描述**: 将AI回复转换为语音
- **技术实现**: 基于Edge-TTS的OpenAI兼容接口
- **关键特性**:
  - 多种语音选择
  - 语速调节（0.25x-4.0x）
  - 多音频格式支持（mp3, wav, opus等）
  - HTTP和WebSocket双模式

### 5. GRAG知识图谱记忆系统

#### 5.1 三元组抽取
- **需求描述**: 从对话中自动提取知识三元组
- **技术实现**: 基于LLM的实体关系抽取
- **关键特性**:
  - 实时三元组抽取
  - 中文语义理解
  - 实体消歧和标准化

#### 5.2 知识图谱存储
- **需求描述**: 将三元组存储为图谱结构
- **技术实现**: Neo4j图数据库
- **关键特性**:
  - 实体关系建模
  - 图谱查询优化
  - 数据持久化

#### 5.3 记忆检索
- **需求描述**: 根据用户查询检索相关记忆
- **技术实现**: 基于相似度的图谱查询
- **关键特性**:
  - 语义相似度计算
  - 上下文相关性排序
  - 记忆融合和总结

#### 5.4 知识图谱可视化
- **需求描述**: 提供图谱的可视化展示
- **技术实现**: PyVis交互式图谱
- **关键特性**:
  - 节点关系可视化
  - 交互式操作
  - 动态布局算法

### 6. 树状思考引擎

#### 6.1 多分支思考
- **需求描述**: 对复杂问题进行多角度分析
- **技术实现**: 并行思考分支生成
- **关键特性**:
  - 逻辑、创新、分析等多种思考类型
  - 并发思考路线生成
  - 思考深度控制

#### 6.2 问题难度评估
- **需求描述**: 自动判断问题复杂度
- **技术实现**: 多维度难度评估算法
- **关键特性**:
  - 文本复杂度分析
  - 关键词识别
  - AI辅助评估

#### 6.3 遗传算法优化
- **需求描述**: 优化思考结果质量
- **技术实现**: 遗传算法剪枝
- **关键特性**:
  - 适应度评估
  - 交叉融合
  - 精英保留策略

#### 6.4 用户偏好过滤
- **需求描述**: 根据用户偏好筛选结果
- **技术实现**: 多维度偏好打分
- **关键特性**:
  - 自定义偏好配置
  - 加权评分算法
  - 相似结果去重

### 7. API服务接口

#### 7.1 RESTful API
- **需求描述**: 提供HTTP API接口
- **技术实现**: FastAPI框架
- **关键特性**:
  - OpenAPI文档自动生成
  - 请求验证和错误处理
  - 异步处理支持

#### 7.2 WebSocket接口
- **需求描述**: 支持实时双向通信
- **技术实现**: WebSocket协议
- **关键特性**:
  - 连接管理
  - 消息广播
  - 断线重连

#### 7.3 API端点设计
- `/chat` - 对话接口
- `/chat/stream` - 流式对话
- `/mcp/handoff` - MCP服务调用
- `/mcp/services` - 服务列表
- `/system/info` - 系统信息
- `/memory/stats` - 记忆统计

### 8. 用户界面

#### 8.1 PyQt5桌面应用
- **需求描述**: 提供原生桌面界面
- **技术实现**: PyQt5 GUI框架
- **关键特性**:
  - 现代化界面设计
  - 消息渲染系统
  - 流式消息显示
  - 代码高亮支持

#### 8.2 消息渲染
- **需求描述**: 优化消息显示效果
- **技术实现**: 模块化渲染器
- **关键特性**:
  - 用户/助手/系统消息区分
  - Markdown渲染
  - 链接识别
  - 附件显示

#### 8.3 设置管理
- **需求描述**: 提供配置界面
- **技术实现**: 配置窗口组件
- **关键特性**:
  - 参数实时调节
  - 配置验证
  - 热重载支持

---

## 非功能需求

### 1. 性能需求

#### 1.1 响应时间
- **对话响应**: < 3秒（普通模式）
- **流式响应**: 首字延迟 < 1秒
- **工具调用**: < 5秒（单次调用）
- **语音合成**: < 2秒（短文本）

#### 1.2 并发能力
- **API并发**: 支持50+并发请求
- **WebSocket连接**: 支持100+同时连接
- **MCP服务**: 支持10+服务同时运行

#### 1.3 资源占用
- **内存使用**: < 2GB（正常运行）
- **CPU占用**: < 50%（空闲时 < 10%）
- **磁盘空间**: < 5GB（包含依赖）

### 2. 可靠性需求

#### 2.1 错误处理
- **API异常**: 自动重试机制
- **服务故障**: 优雅降级
- **网络中断**: 断线重连
- **数据损坏**: 备份恢复

#### 2.2 稳定性
- **长时间运行**: 24/7稳定运行
- **内存泄漏**: 自动内存管理
- **连接池**: 连接复用和清理

### 3. 可扩展性需求

#### 3.1 模块化设计
- **插件系统**: 支持第三方插件
- **MCP协议**: 标准化服务接口
- **配置系统**: 灵活配置管理

#### 3.2 水平扩展
- **分布式部署**: 支持多实例部署
- **负载均衡**: API请求分发
- **数据同步**: 跨实例数据共享

### 4. 安全需求

#### 4.1 数据安全
- **API密钥**: 安全存储和传输
- **用户数据**: 本地存储保护
- **通信加密**: HTTPS/WSS协议

#### 4.2 访问控制
- **API认证**: 可选的API密钥验证
- **权限管理**: 功能访问控制
- **审计日志**: 操作记录追踪

### 5. 兼容性需求

#### 5.1 平台支持
- **Windows**: Windows 10/11 + PowerShell 5.1+
- **macOS**: macOS 10.15+ + Homebrew
- **Linux**: Ubuntu 18.04+（理论支持）

#### 5.2 Python版本
- **最低版本**: Python 3.8
- **推荐版本**: Python 3.11
- **依赖管理**: 支持pip和uv

---

## 技术约束

### 1. 开发约束

#### 1.1 编程语言
- **主语言**: Python 3.8+
- **配置格式**: JSON + Pydantic
- **文档格式**: Markdown

#### 1.2 框架选择
- **GUI**: PyQt5（固定）
- **Web**: FastAPI（固定）
- **AI**: OpenAI兼容API
- **数据库**: Neo4j（GRAG系统）

#### 1.3 代码风格
- **设计原则**: 极致精简
- **模块化**: 高内聚低耦合
- **异步优先**: async/await模式

### 2. 部署约束

#### 2.1 依赖管理
- **包管理器**: 推荐uv，兼容pip
- **虚拟环境**: 必须使用虚拟环境
- **依赖锁定**: pyproject.toml管理

#### 2.2 配置管理
- **配置文件**: config.json
- **环境变量**: 支持.env文件
- **配置验证**: Pydantic类型检查

### 3. 集成约束

#### 3.1 外部服务
- **LLM API**: 必须兼容OpenAI格式
- **Neo4j**: 版本4.0+
- **Edge-TTS**: 网络连接要求

#### 3.2 系统依赖
- **浏览器**: Chromium（Playwright）
- **音频**: 系统音频驱动
- **网络**: 稳定的互联网连接

---

## 质量属性

### 1. 可维护性
- **模块化架构**: 清晰的模块边界
- **代码注释**: 完整的文档注释
- **测试覆盖**: 核心功能单元测试
- **版本控制**: Git版本管理

### 2. 可用性
- **用户界面**: 直观的GUI设计
- **错误提示**: 友好的错误信息
- **帮助文档**: 完整的使用说明
- **快速开始**: 一键部署脚本

### 3. 可观测性
- **日志系统**: 分级日志记录
- **性能监控**: 关键指标监控
- **错误追踪**: 异常堆栈记录
- **调试支持**: 开发者模式

### 4. 可配置性
- **参数调节**: 丰富的配置选项
- **热重载**: 配置动态生效
- **环境适配**: 多环境配置支持
- **默认值**: 合理的默认配置

---

## 风险分析

### 1. 技术风险

#### 1.1 AI API依赖
- **风险**: API服务不稳定或变更
- **影响**: 核心功能不可用
- **缓解**: 多API支持，本地模型备选

#### 1.2 依赖库兼容性
- **风险**: 第三方库版本冲突
- **影响**: 安装失败或功能异常
- **缓解**: 版本锁定，兼容性测试

#### 1.3 跨平台兼容性
- **风险**: 不同操作系统行为差异
- **影响**: 部分功能在某些平台不可用
- **缓解**: 平台特定处理，充分测试

### 2. 性能风险

#### 2.1 内存泄漏
- **风险**: 长时间运行内存持续增长
- **影响**: 系统性能下降或崩溃
- **缓解**: 内存监控，定期清理

#### 2.2 并发瓶颈
- **风险**: 高并发时性能急剧下降
- **影响**: 用户体验差，服务不可用
- **缓解**: 连接池，异步处理，负载测试

### 3. 安全风险

#### 3.1 API密钥泄露
- **风险**: 配置文件中的敏感信息泄露
- **影响**: 账户安全，费用损失
- **缓解**: 环境变量，加密存储

#### 3.2 代码注入
- **风险**: 用户输入导致代码执行
- **影响**: 系统安全，数据泄露
- **缓解**: 输入验证，沙箱执行

### 4. 业务风险

#### 4.1 用户数据丢失
- **风险**: 对话历史或记忆数据丢失
- **影响**: 用户体验下降，数据价值损失
- **缓解**: 定期备份，数据恢复机制

#### 4.2 服务中断
- **风险**: 关键服务长时间不可用
- **影响**: 用户无法正常使用
- **缓解**: 服务监控，快速恢复，降级方案

---

## 项目里程碑

### Phase 1: 核心功能 (已完成)
- ✅ 基础对话引擎
- ✅ MCP服务框架
- ✅ PyQt5界面
- ✅ 配置系统

### Phase 2: 扩展功能 (已完成)
- ✅ 语音交互系统
- ✅ GRAG记忆系统
- ✅ 树状思考引擎
- ✅ API服务接口

### Phase 3: 优化完善 (已完成)
- ✅ 性能优化
- ✅ 错误处理
- ✅ 文档完善
- ✅ 部署脚本

### Phase 4: 生态建设 (进行中)
- 🔄 插件生态
- 🔄 社区建设
- 🔄 第三方集成
- 🔄 商业化探索

---

## 总结

NagaAgent 3.0是一个功能完整、架构清晰的智能对话助手系统。项目采用模块化设计，具有良好的可扩展性和可维护性。通过MCP协议实现了丰富的功能集成，通过GRAG系统提供了持久化记忆能力，通过树状思考引擎提升了复杂问题的处理能力。

项目的核心优势在于：
1. **架构清晰**: 分层架构，职责明确
2. **功能丰富**: 涵盖对话、语音、记忆、工具调用等
3. **易于扩展**: 标准化的MCP和Agent接口
4. **用户友好**: 直观的GUI和完善的API
5. **部署简单**: 一键部署脚本，依赖管理完善

项目已经达到了生产可用的水平，具备了商业化的基础条件。未来的发展方向主要是生态建设和性能优化，以及更多专门化Agent的开发。